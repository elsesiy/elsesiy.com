<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/jpeg" href="/favicon.ico">
  <title>
    
      Jonas-Taha El Sesiy
    
  </title>
  
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="Jonas-Taha El Sesiy" href="/feed.xml">
  
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DCTKG65YG8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DCTKG65YG8', { 'anonymize_ip': true });
</script>

  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" href="/">Jonas-Taha El Sesiy</a>
  
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger">
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewbox="0 0 18 15" width="18px" height="15px">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a href="/" class="page-link active">Blog</a>
        <a href="/archive" class="page-link ">Archive</a>
        <a href="/about" class="page-link ">About</a>
      </div>
    </nav>
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="sidebar">
  <h1 style="font-size: 21px;">Jonas-Taha El Sesiy</h1>
  <p>Software Engineer</p>
  <p><a href="/about">Who am I?</a></p>
  <img src="/assets/Jonas-TahaElSesiy.jpg">

  <!-- Social links -->
  <ul class="social-media-list" style="margin-top: 20px; margin-bottom: 30px;">
    <li>
      <a href="https://github.com/elsesiy" target="_blank"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
    <li>
      <a href="https://twitter.com/elsesiy" target="_blank"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
    <li>
      <a href="https://www.linkedin.com/in/elsesiy"><span class="icon icon--linked"><svg width="16px" height="16px" viewbox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
  </ul>

  <hr>

  <p style="line-height: 100%">
  <small>All views expressed are my own and not affiliated with current or former employers. Unless otherwise mentioned in the post, all projects are side projects which I work on on weekends and evenings.</small>
</p>
</div>


        <div class="home">
  
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline"><a href="/blog/kubernetes-client-source-ip-dilemma">Kubernetes: The client source IP preservation dilemma</a></h1>
        <p class="post-meta">
          <time datetime="2020-10-12T00:00:00+00:00" itemprop="datePublished">
            
            Oct 12, 2020
          </time>
          </p>
      </header>

      <div class="post-content" itemprop="articleBody">
        
            <div>
              <p>A topic that’s been keeping me busy for a while now is how to ensure zero downtime when working in environments where the client source IP needs to be preserved. Let me elaborate on what the problem statement is exactly.</p>

<p>If you deploy an application on <a href="https://kubernetes.io">Kubernetes</a> using a service type <code class="language-plaintext highlighter-rouge">LoadBalancer</code>, the cloud controller manager deploys a L4 load balancer in your respective cloud provider environment and <em>usually</em> allocates a public IP address for it. This allows users to effortlessly expose services to the public internet and common use cases include L7 load balancing solutions such as NGINX or Envoy. So far so good. Now if your application requires to know the real client IP this becomes a problem. 

            </p>
</div>
            <input type="checkbox" class="read-more-state" id="/blog/kubernetes-client-source-ip-dilemma">
            <div class="read-more">
              

<p>To understand the difficulty with this scenario, let’s have a look at how traffic routing works within Kubernetes. Each node runs <code class="language-plaintext highlighter-rouge">kube-proxy</code> which watches the API server for the addition or removal of service and endpoint objects. Without going into too much detail on user space, iptables and ipvs proxy modes, the basic idea is simple. When <code class="language-plaintext highlighter-rouge">kube-proxy</code> sees a new service, it will open up a new (random) port on each node for it. Now, when a client connects to the service IP, the proxy redirects traffic to its own port using some low-level routing logic, selects a backend and will proxy traffic from the client to it.</p>

<p>This works across nodes as the Kubernetes master assigns virutal IPs for services and <code class="language-plaintext highlighter-rouge">kube-proxy</code> keeps track of backends across nodes. For more info on this matter, I suggest taking a look at the outstanding official documentation <a href="https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">here</a>.</p>

<p>For the more visiual readers, here’s how this looks when using <code class="language-plaintext highlighter-rouge">iptables</code> proxy mode (most common).</p>

<p><img src="/assets/posts/2020-10-12-kube-proxy-iptables.svg" alt=""></p>

<p class="image-caption"><em>Source: Kubernetes documentation</em></p>

<p>What you just read unfortunately doesn’t preserve the client source IP because <code class="language-plaintext highlighter-rouge">kube-proxy</code> replaces the source IP with a cluster internal IP due to the fact that the proxy randomly selects a backend to forward the traffic to. To prevent that, Kubernetes has a feature which explicitly tells <code class="language-plaintext highlighter-rouge">kube-proxy</code> to proxy requests only to local endpoints and not to other nodes. It’s as simple as setting the <code class="language-plaintext highlighter-rouge">service.spec.externalTrafficPolicy</code> to <code class="language-plaintext highlighter-rouge">Local</code> instead of the default <code class="language-plaintext highlighter-rouge">Cluster</code>. One thing to note here is that if there are no local endpoints, packets will be dropped. Again, more info on this can be found in the <a href="https://kubernetes.io/docs/tutorials/services/source-ip/">official docs</a>.</p>

<p>Great, now our application is able to retrieve the actual client source IP instead of a cluster internal IP. This all sounds good until you have to think about upgrading your backend pods for the load balancer service, doing worker node ugprades or replacing entire nodepools.</p>

<p>Here’s why…<br>
When a new service is added, the cloud provider’s load balancer backend pools is updated with the node IP and node port selected by <code class="language-plaintext highlighter-rouge">kube-proxy</code>. It then periodically checks whether the application is healthy using periodic probing. The healthchecks usually have to fail a certain retry count before the cloud provider decides to remove the ip from the load balancer pool. Now if <code class="language-plaintext highlighter-rouge">kube-proxy</code> doesn’t forward traffic to a different node and there’s a delay between the service endpoint removal and the cloud provider backend pool ip romal, we’re blackholing traffic.</p>

<p>Unlike adding a new service endpoint which automatically gets propagated to the cloud load balancer configuration, the removal of an endpoint does not. This could be seen as a design flaw of the cloud controller manager implementation but this is not a trivial problem to solve as the cloud provider has no way of knowing how downstream applications behave when connections are closed.</p>

<p>When presented with the aforementioned problem statement, solutions often propose adding the following two remediation items:</p>

<ol>
  <li>Configure a <code class="language-plaintext highlighter-rouge">preStop</code> hook for the backend pods to <code class="language-plaintext highlighter-rouge">sleep</code> for a certain period of time</li>
  <li>Configure <code class="language-plaintext highlighter-rouge">terminationGracePeriodSeconds</code> for the pods to allow gracefully handle open connections before pod shutodwn</li>
</ol>

<p>These are certainly important suggestions but only help in the case of a pod rolling update and only if either duration is at least as long as the cumulative time it takes for the health probes to fail and the backend pool to be updated. Since you might not have thought about this early on, you’re out of luck as changing it will trigger pod restarts.</p>

<p>At the heart of the issue is the fact that the node is registered to the load balancer and not individual pods. What complicates matters is the fact, that the service endpoint is removed regardless of a <code class="language-plaintext highlighter-rouge">preStop</code> hook or the <code class="language-plaintext highlighter-rouge">terminationGracePeriodSeconds</code>, see <a href="https://github.com/kubernetes/kubernetes/issues/67592">this issue</a> for more context. Due to these circumstances it’s almost inevitable to end in a situation where new connections go nowhere which will cause a service disruption for a few unlucky users of your service (the endpoint is removed from the service while the existing pod on a node gracefully terminates and there may not be a second pod on the same node to serve the request).</p>

<p>Here’s a small diagram depicting the unfortunate situation.</p>

<p><img src="/assets/posts/2020-10-12-LB-dilemma.png" alt=""></p>

<p>So what can you do you’re asking?<br>
Well, until the the Kubernetes Enhancement Proposal (<a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-network/1669-proxy-terminating-endpoints">KEP-1669</a>) is implemented which will dramatically improve the situation: not much. From what I know, you have to write some custom tooling to safely remove a node from your cloud provider load balancer outside of kubernetes since none of the existing primitives allow for zero downtime deployments.</p>

<p>Thanks for reading! It’s unfortunate that I can’t present you with a good solution but feel free to share your thoughts and reach out if you have any questions. Until next time <img class="emoji" title=":wave:" alt=":wave:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png" height="20" width="20"></p>


            </div>
            <label for="/blog/kubernetes-client-source-ip-dilemma" class="read-more-trigger"></label>
        
      </div>

      <p class="extra-info">
        
          Tags: kubernetes, k8s, cncf, source ip, load balancer, kube-proxy, externalTrafficPolicy, graceful termination, zero downtime
        
      </p>
    </article>
  
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline"><a href="/blog/how-to-kubectl-plugin">Kubernetes: How to write a kubectl plugin</a></h1>
        <p class="post-meta">
          <time datetime="2019-10-27T00:00:00+00:00" itemprop="datePublished">
            
            Oct 27, 2019
          </time>
          </p>
      </header>

      <div class="post-content" itemprop="articleBody">
        
            <div>
              <p>Hacktoberfest is almost over but since there’re plenty of opportunities to contribute, I decided to take over the task of re-writing a <code class="language-plaintext highlighter-rouge">kubectl</code> plugin called <code class="language-plaintext highlighter-rouge">view-secret</code>.
For those of you who are not familar with <code class="language-plaintext highlighter-rouge">kubectl</code>, it’s the CLI tool to work with <a href="https://kubernetes.io">Kubernetes</a>.
In this post I’d like to shed some light on <a href="https://krew.dev">krew</a> and what’s necessary to create your very own plugin. Okay, so what’s krew?</p>

<p>Krew is one of the many Kubernetes Special Interest Groups (SIG) and aims at solving the package management issue for <code class="language-plaintext highlighter-rouge">kubectl</code>. There’s a limited amount of core functionality that ships with <code class="language-plaintext highlighter-rouge">kubectl</code> so krew is all about allowing developers to create their own extensions and contribute them back to the community. All available plugins are stored in the <a href="https://github.com/kubernetes-sigs/krew-index">krew-index</a>, a central repo that plugin maintainers use to publish/update their plugins. If you haven’t used krew before, make sure to <a href="https://github.com/kubernetes-sigs/krew/#installation">install</a> it first.</p>


            </div>
            <input type="checkbox" class="read-more-state" id="/blog/how-to-kubectl-plugin">
            <div class="read-more">
              
<p>Some early plugins have been written in Bash and the maintainer was asking the community to take over the re-write in Go/Python and ultimately the maintenance of the plugins.
Since my day job requires me to create &amp; manage Kubernetes-based deployments, I find myself in need of decoding secrets all the time.
A <code class="language-plaintext highlighter-rouge">secret</code> - <em>as the name may reveal already</em> - is used to store secret information <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encoded. This resource type is often used to populate environment configuration for deployments, to store docker registry auth information or tls secrets.</p>

<p>The typical workflow to decode a secret without <code class="language-plaintext highlighter-rouge">view-secret</code> looks as follows:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">kubectl get secret &lt;secret&gt; -o yaml</code></li>
  <li>Copy base64 encoded secret</li>
  <li><code class="language-plaintext highlighter-rouge">echo "b64string" | base64 -d</code></li>
</ol>

<p>This gets quite cumbersome especially if you just want to check the entirety of a secret to see if everything looks ok.
There are solutions like <a href="https://github.com/mveritym/kubedecode">kubedecode</a> or the previous <a href="https://github.com/ahmetb/kubectl-extras/tree/master/view-secret">view-secret</a> implementation that aim at solving this problem but lack either native <code class="language-plaintext highlighter-rouge">kubectl</code> integration, are outdated/not maintained anymore or require you to always provide e.g. the <code class="language-plaintext highlighter-rouge">namespace</code> as a parameter.</p>

<p>So I went ahead and created a new implementation for <a href="https://github.com/elsesiy/kubectl-view-secret">view-secret</a> that is backward-compatible to the existing implementation but also adds a new capability, namely decoding all contents of a secret. My contribution has been <a href="https://github.com/kubernetes-sigs/krew-index/pull/287">accepted</a> and the plugin is available now, so let me walk you through the process.</p>

<p>As it turns out, creating your own plugin is super simple and well documented <a href="https://github.com/kubernetes-sigs/krew/blob/master/docs/DEVELOPER_GUIDE.md">here</a>. All you have to do is create a binary with the prefix <code class="language-plaintext highlighter-rouge">kubectl-</code>, make it executable and place it somewhere in your <code class="language-plaintext highlighter-rouge">$PATH</code>. A sample plugin can be as easy as this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kubectl-hello plugin</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; kubectl-hello
#!/usr/bin/env bash
echo "hello from krew"
</span><span class="no">EOF

</span><span class="c"># Make executable</span>
<span class="nb">chmod</span> +x kubectl-hello

<span class="c"># Copy into some $PATH location</span>
<span class="nb">cp </span>kubectl-hello /usr/local/bin

<span class="c"># Run plugin</span>
kubectl hello
<span class="c">## prints "hello from krew"</span>
</code></pre></div></div>

<p>Since my language of choice for this project was Go, I created a new project and added integrations such as <a href="https://goreleaser.com/">GoReleaser</a> to simplify shipping the binary for mulitple platforms and <a href="https://travis-ci.com/">Travis CI</a> to automate running builds/creating releases. To simplify the build/test process I also added a <code class="language-plaintext highlighter-rouge">Makefile</code>.
At this point my project repo had the following layout:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmd
  kubectl-view-secret.go
pkg
  cmd
    view-secret.go
    view-secret_test.go
go.mod
go.sum
.goreleaser.yml
.travis.yml
Makefile
</code></pre></div></div>

<p>The established workflow was pretty straight-forward:</p>

<ol>
  <li>push changes to master –&gt; triggers travis to run tests</li>
  <li>tag commit –&gt; triggers travis to use goreleaser</li>
</ol>

<p>I previously <a href="/blog/containerization-of-golang-applications">wrote</a> about the usage of <code class="language-plaintext highlighter-rouge">Makefile</code>s in Go projects but for this project the targets are much simpler:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SOURCES :<span class="o">=</span> <span class="si">$(</span>shell find <span class="nb">.</span> <span class="nt">-name</span> <span class="s1">'*.go'</span><span class="si">)</span>
BINARY :<span class="o">=</span> kubectl-view-secret

build: kubectl-view-secret

<span class="nb">test</span>: <span class="si">$(</span>SOURCES<span class="si">)</span>
  go <span class="nb">test</span> <span class="nt">-v</span> <span class="nt">-short</span> <span class="nt">-race</span> <span class="nt">-timeout</span> 30s ./...

<span class="si">$(</span>BINARY<span class="si">)</span>: <span class="si">$(</span>SOURCES<span class="si">)</span>
  <span class="nv">CGO_ENABLED</span><span class="o">=</span>0 go build <span class="nt">-o</span> <span class="si">$(</span>BINARY<span class="si">)</span> <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-s -w"</span> ./cmd/<span class="si">$(</span>BINARY<span class="si">)</span>.go
</code></pre></div></div>

<p>For the actual implementation I used <a href="https://github.com/spf13/cobra">spf13/cobra</a> to parse flags and process user input. To get the secret contents I use <code class="language-plaintext highlighter-rouge">exec.Command</code> thus shelling out to the OS instead of using the kubernetes <a href="https://github.com/kubernetes/client-go">go client</a> or <a href="https://github.com/kubernetes/cli-runtime">cli runtime</a> as they add a huge overhead for such a small functionality.</p>

<p>After I finished the implementation, all I had to do was update the <code class="language-plaintext highlighter-rouge">plugins/view-secret.yaml</code> spec in the krew index to <a href="https://github.com/kubernetes-sigs/krew-index/pull/287">use my new plugin</a>. This meant changing the plugin description, the download links for the new binaries and the <code class="language-plaintext highlighter-rouge">sha256</code> checksums. Once the Pull Request got merged, the local plugin index had to be updated via <code class="language-plaintext highlighter-rouge">kubectl krew update</code> and the plugin can be installed via <code class="language-plaintext highlighter-rouge">kubectl krew install view-secret</code>.</p>

<p>Now the workflow to decode secrets is as simple as this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># print secret keys</span>
kubectl view-secret &lt;secret&gt;

<span class="c"># decode specific entry</span>
kubectl view-secret &lt;secret&gt; &lt;key&gt;

<span class="c"># decode all secret contents</span>
kubectl view-secret &lt;secret&gt; <span class="nt">-a</span>/--all

<span class="c"># print keys for secret in different namespace</span>
kubectl view-secret &lt;secret&gt; <span class="nt">-n</span>/--namespace foo

<span class="c"># suppress info output</span>
kubectl view-secret &lt;secret&gt; <span class="nt">-q</span>/--quiet
</code></pre></div></div>

<p>This was my first <a href="https://www.cncf.io/">CNCF</a> contribution &amp; I’m happy about the feedback I got from <a href="https://github.com/ahmetb">@ahmetb</a> &amp; <a href="https://github.com/corneliusweig">@corneliusweig</a> throughout the process.</p>

<p>The full plugin code is available on <a href="https://github.com/elsesiy/kubectl-view-secret">GitHub</a>.</p>

<p>Thanks for reading! As always please reach out if you have any questions. <img class="emoji" title=":wave:" alt=":wave:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png" height="20" width="20"></p>


            </div>
            <label for="/blog/how-to-kubectl-plugin" class="read-more-trigger"></label>
        
      </div>

      <p class="extra-info">
        
          Tags: krew, kubectl, plugin, kubernetes, k8s, cncf, hacktoberfest
        
      </p>
    </article>
  
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline"><a href="/blog/oauth2-proxy-dynamic-callback-urls">Kubernetes: oauth2_proxy with dynamic callback urls</a></h1>
        <p class="post-meta">
          <time datetime="2019-04-07T00:00:00+00:00" itemprop="datePublished">
            
            Apr 7, 2019
          </time>
          </p>
      </header>

      <div class="post-content" itemprop="articleBody">
        
            <div>
              <p>We all love the simplicity of deploying applications on Kubernetes and while many tutorials out there help you get started quickly and provide a great resource for many, some of them spare important details. In this post, I try to <a href="https://github.com/pusher/oauth2_proxy/issues/109">help</a> the community by providing a small guide on how to deploy <a href="https://github.com/pusher/oauth2_proxy">oauth2_proxy</a> with dynamic callback urls. But first, what is oauth2_proxy and which problem does it solve?</p>

<p>The <code class="language-plaintext highlighter-rouge">README.md</code> explains it as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A reverse proxy and static file server that provides authentication using Providers (Google, GitHub, and others) to validate accounts by email, domain or group.
</code></pre></div></div>

<p>Okay great, so this tool comes in handy if you want to authenticate users for an application that doesn’t offer authentication by itself. Famous examples include the <a href="https://github.com/kubernetes/dashboard">Kubernetes dashboard</a>, <a href="https://github.com/prometheus/prometheus">Prometheus</a> or <a href="https://github.com/prometheus/alertmanager">Alertmanager</a>.</p>

<p>There are multiple ways to solve the issue of serving apps that don’t offer authentication out-of-the-box:</p>

<ol>
  <li>Don’t expose it at all and just browse it using <code class="language-plaintext highlighter-rouge">kubectl port-forward</code>. This way, the application is never publicly exposed on the internet.</li>
  <li>Expose it and handle authentication in a proxy sitting in front of the application using <code class="language-plaintext highlighter-rouge">oauth2_proxy</code> via existing providers (Microsoft, GitHub, etc.).</li>
  <li>Establish your own (federated) idendity provider to handle user authentication using i.e. <a href="https://github.com/dexidp/dex">dex</a>.</li>
</ol>


            </div>
            <input type="checkbox" class="read-more-state" id="/blog/oauth2-proxy-dynamic-callback-urls">
            <div class="read-more">
              
<p>For the first option everyone who needs access to these tools need cluster access, so this is not a very flexible option. The second option is definitely more interesting because we can safely expose the applications on the public internet without much effort. The third option offer the most flexiblity but is a bit of an overkill for what I’m trying to achieve. Hence, I’ll be focusing on No. 2. But we might not want to have mulitple proxies in place which handle authentication independently for the respective app but rather a single instance that can be used by all apps. Let’s go through an example:</p>

<p>I want to expose Alertmananger and Prometheus to the same group of people and they should be able to seemlessly switch between the applications without the need to sign-in again.</p>

<p>First, I’ll be using helm to install the chart for <code class="language-plaintext highlighter-rouge">oauth2_proxy</code> and setting some custom properties which I need for the OAuth2 provider of my choice:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install stable/oauth2-proxy --name login-oauth2-proxy \
--namespace xyz \
--set config.clientID="${CLIENT_ID}" \
--set config.clientSecret="${CLIENT_SECRET}" \
--set config.cookieSecret="${COOKIE_SECRET}" \
--set extraArgs.provider="azure" \
--set extraArgs.azure-tenant="${AZURE_TENANT_ID}" \
--set extraArgs.whitelist-domain=".mydomain.com" \
--set extraArgs.cookie-domain=".mydomain.com" \
--tls
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">clientID</code>, <code class="language-plaintext highlighter-rouge">clientSecret</code> and <code class="language-plaintext highlighter-rouge">azure-tenant</code> can be obtained upon registering the application for Azure Active Directory integration as described <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#create-an-azure-active-directory-application">here</a>. To restrict access to only a subset of users from the Active Directory make sure to follow <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-restrict-your-app-to-a-set-of-users">these instructions</a> after. It’s important to register the url of the ingress rule that will be used for authentication (see below), in my case <code class="language-plaintext highlighter-rouge">https://login.mydomain.com/oauth2/callback</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">cookieSecret</code> is just a random secret that can be generated with a simple python script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -ti --rm python:3-alpine python -c 'import secrets,base64; print(base64.b64encode(base64.b64encode(secrets.token_bytes(16))));'
</code></pre></div></div>

<p>Worth mentioning are the <code class="language-plaintext highlighter-rouge">whilelist-domain</code> and <code class="language-plaintext highlighter-rouge">cookie-domain</code> flags which should point to the parent domain of the applications to be protected, i.e.<br>
You want to protect <code class="language-plaintext highlighter-rouge">prom.mydomain.com</code> and <code class="language-plaintext highlighter-rouge">alerts.mydomain.com</code> then this needs to be set to <code class="language-plaintext highlighter-rouge">.mydomain.com</code>.</p>

<p>Great, now we need an ingress route that handles authentication via the proxy we just deployed. This looks as simple as this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: login-ingress-oauth2
  namespace: xyz
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  rules:
  - host: login.mydomain.com
    http:
      paths:
      - backend:
          serviceName: login-oauth2-proxy
          servicePort: 80
        path: /oauth2
  tls:
  - hosts:
    - login.mydomain.com
</code></pre></div></div>

<p>Now all we have to do for the application that should be protected via our proxy is to use the <code class="language-plaintext highlighter-rouge">auth-url</code> and <code class="language-plaintext highlighter-rouge">auth-signin</code> annotations of nginx and have them reference this ingress route.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: alertmanager-ingress
  namespace: tiller
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/auth-url: "https://login.mydomain.com/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://login.mydomain.com/oauth2/start?rd=https://$host$request_uri"
spec:
  rules:
  - host: alerts.mydomain.com
    http:
      paths:
      - backend:
          serviceName: prom-prometheus-operator-alertmanager
          servicePort: 9093
        path: /
  tls:
  - hosts:
    - alerts.mydomain.com
</code></pre></div></div>

<p>Browsing <code class="language-plaintext highlighter-rouge">alerts.mydomain.com</code> will redirect to the microsoft login and after successful authentication back to the application. If you deploy multiple application using this method you won’t have to login again as the consent has been granted already and a valid cookie exists.</p>

<p>A few things to be mentioned:</p>

<ol>
  <li>Depending on how many applications rely on the proxy, you might want to scale the oauth2_proxy deployment to ensure availability</li>
  <li>None of the explanations above indicate that you shouldn’t be taking care of proper RBAC rules in your cluster and restrict access to the applications according to the principle of least privilege.</li>
</ol>

<p>That’s it for now, please reach out if you have further questions or remarks. Happy Sunday!</p>


            </div>
            <label for="/blog/oauth2-proxy-dynamic-callback-urls" class="read-more-trigger"></label>
        
      </div>

      <p class="extra-info">
        
          Tags: oauth2_proxy, nginx, sso, single sign-on, reverse proxy, nginx, kubernetes
        
      </p>
    </article>
  
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline"><a href="/blog/containerization-of-golang-applications">Containerization of Golang applications</a></h1>
        <p class="post-meta">
          <time datetime="2019-01-09T00:00:00+00:00" itemprop="datePublished">
            
            Jan 9, 2019
          </time>
          </p>
      </header>

      <div class="post-content" itemprop="articleBody">
        
            <div>
              <p>I’ve been a working a lot in <a href="https://golang.org/">Golang</a> recently and even though it easily allows for single static binary compilation I find myself using <a href="https://www.docker.com/">Docker</a> a lot. Why? Well, especially when it comes to container orchestration and scaling of workloads some sort of container technology is used as these build the foundation of a Pod in <a href="https://kubernetes.io/">Kubernetes</a> (our deployment infrastructure).</p>

<p>While coming up with an initial Dockerfile is easy, correctly compiling a Go application and adhere to all sorts of container best practices is still hard. Does the size of the binary matter? If so, you might want to provide some additional flags during compilation. 
Do you build the app outside of the container and just copy the final artifact into it or do you use multi-stage builds to have everything within an isolated environment? How do you deal with caching of layers? How do you make sure that the final container is secure and only contains whatever is needed to execute your application? 

            </p>
</div>
            <input type="checkbox" class="read-more-state" id="/blog/containerization-of-golang-applications">
            <div class="read-more">
              
The first thing I was overwhelmed with is how much old information is still out there and that even well-known developers such as <a href="http://www.hockin.org/~thockin/">Tim Hockin</a> (co-creator of Kubernetes) are having <a href="https://twitter.com/thockin/status/758814480931229697?lang=en">questions</a> on how to actually compile a Golang application <em>correctly</em>. As it turns out, some flags are <a href="https://plus.google.com/117192131596509381660/posts/eNnNePihYnK">strictly unnecessary</a> as of Go 1.10 but are still widely used. Ultimately, it all depends on your needs and whether you need <a href="https://golang.org/cmd/cgo/">cgo</a> or not but even after studying a lot of blog posts I’m still not 100% sure about my approach. As it turns out, Tim created a nice <a href="https://github.com/thockin/go-build-template">skeleton project</a> which is a good starting point in my opinion.

<p>Furthermore, I saw a lot of different approaches in terms of runtime base image and how the build process takes place. Some are using for <code class="language-plaintext highlighter-rouge">golang:alpine</code> with manually installing ca-certs, tzinfo, etc. during the build stage whereas others use plain <code class="language-plaintext highlighter-rouge">golang</code> instead. For the final stage common choices are either <code class="language-plaintext highlighter-rouge">scratch</code> or <code class="language-plaintext highlighter-rouge">alpine</code> which still provide a larger attack surface than i.e. <code class="language-plaintext highlighter-rouge">gcr.io/distroless/base</code>. As with many things, there’s not a single <em>correct</em> approach because one might want to keep the ability to <code class="language-plaintext highlighter-rouge">docker exec -it</code> into a container around whereas others have better ways to debug their services.</p>

<p>While coming up with my current solution I had the following considerations to take into account. Local development should still be fast, the build process must be CI-friendly with clean &amp; reproduceable builds and no additional tooling needed to secure the final image such as <a href="https://github.com/aquasecurity/microscanner">microscanner</a> or <a href="https://github.com/coreos/clair">clair</a>. Hence, I created a <code class="language-plaintext highlighter-rouge">Makefile</code> that helps me take care of the heavy lifting and allows for fast local development where no Docker is used at all. A shortened &amp; simplified version looks as follows:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">OUT</span> <span class="o">:=</span> binary-name
<span class="nv">PKG</span> <span class="o">:=</span> github.com/package
<span class="nv">VERSION</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> git describe <span class="nt">--always</span> <span class="nt">--dirty</span><span class="nf">)</span>
<span class="nv">PKG_LIST</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> go list <span class="nv">${PKG}</span>/...<span class="nf">)</span>
<span class="nv">GO_FILES</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> find <span class="nb">.</span> <span class="nt">-name</span> <span class="s1">'*.go'</span><span class="nf">)</span>

<span class="nl">build</span><span class="o">:</span>
	go build <span class="nt">-i</span> <span class="nt">-v</span> <span class="nt">-o</span> <span class="nv">${OUT}</span> <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-X main.version=</span><span class="nv">${VERSION}</span><span class="s2">"</span> <span class="nv">${PKG}</span>

<span class="nl">test</span><span class="o">:</span>
	<span class="p">@</span>go <span class="nb">test</span> <span class="nt">-short</span> <span class="nv">${PKG_LIST}</span>

<span class="nl">vet</span><span class="o">:</span>
	<span class="p">@</span>go vet <span class="nv">${PKG_LIST}</span>

<span class="nl">errorcheck</span><span class="o">:</span>
	<span class="p">@</span>errcheck <span class="nv">${PKG_LIST}</span>

<span class="nl">lint</span><span class="o">:</span>
	<span class="p">@</span><span class="k">for </span>file <span class="k">in</span> <span class="nv">${GO_FILES}</span> <span class="p">;</span>  <span class="k">do</span> <span class="se">\</span>
		golint <span class="nv">$$</span>file <span class="p">;</span> <span class="se">\</span>
	<span class="k">done</span>

<span class="nl">container</span><span class="o">:</span>
	<span class="p">@</span>docker build <span class="nt">--build-arg</span> <span class="nv">VERSION</span><span class="o">=</span><span class="nv">${VERSION}</span> <span class="nt">-t</span> registry/image:<span class="nv">${VERSION}</span> .

<span class="nl">container-push</span><span class="o">:</span>
	<span class="p">@</span>docker push registry/image:<span class="nv">${VERSION}</span>

<span class="nl">run</span><span class="o">:</span> <span class="nf">build</span>
	./<span class="nv">${OUT}</span>

<span class="nl">clean</span><span class="o">:</span>
	<span class="p">-</span>@rm <span class="nv">${OUT}</span> <span class="nv">${OUT}</span>-<span class="k">*</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">run build vet lint errorcheck</span>
</code></pre></div></div>

<p>I’ll talk about <code class="language-plaintext highlighter-rouge">-ldflags</code> in a bit, so don’t worry about it for now. Since the regular <code class="language-plaintext highlighter-rouge">go build</code> command doesn’t do static analysis on the project files, I created steps like <code class="language-plaintext highlighter-rouge">vet</code> (checks for correctness/suspicious constructs), <code class="language-plaintext highlighter-rouge">lint</code> (style mistakes) and <code class="language-plaintext highlighter-rouge">errorcheck</code> (missing error handling) I can run whenever I feel like it. This is not done implicitly through another step such as <code class="language-plaintext highlighter-rouge">build</code> because my CI system takes care of these things too. The rest of the file should be self-explanatory if you’re familiar with make.<br>
Now, the following <code class="language-plaintext highlighter-rouge">Dockerfile</code> is only used in my CI system for which I don’t mind it to fetch the dependencies during each build.</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Build stage</span>
<span class="k">FROM</span><span class="s"> golang:1.11.4 AS build-env</span>

<span class="k">LABEL</span><span class="s"> maintainer="Jonas-Taha El Sesiy &lt;github@elsesiy.com&gt;"</span>

<span class="k">WORKDIR</span><span class="s"> /project</span>
<span class="k">ARG</span><span class="s"> VERSION</span>
<span class="k">COPY</span><span class="s"> main.go go.mod go.sum ./</span>
<span class="k">RUN </span>bash <span class="nt">-c</span> <span class="s2">"go get -d &amp;&gt; /dev/null"</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-ldflags</span> <span class="s2">"-X main.version=</span><span class="k">${</span><span class="nv">VERSION</span><span class="k">}</span><span class="s2"> -s -w"</span> <span class="nt">-a</span> <span class="nt">-o</span> app .

<span class="c"># Final stage</span>
<span class="k">FROM</span><span class="s"> gcr.io/distroless/base</span>
<span class="k">COPY</span><span class="s"> --from=build-env /project/app .</span>
<span class="k">CMD</span><span class="s"> ["./app"]</span>
</code></pre></div></div>

<p>I’m using multi-stage builds with the latest Golang version as the base image. For the final stage, I opted for <a href="https://github.com/GoogleContainerTools/distroless#why-should-i-use-distroless-images">distroless</a> even though the final image is <strong>bigger</strong> than the other choices. Note that I’m using go modules for dependency management introduced in Go 1.11 for which I copy the <code class="language-plaintext highlighter-rouge">go.mod</code> and <code class="language-plaintext highlighter-rouge">go.sum</code> files into the container.<br>
As mentioned before, there are a couple of flags passed onto the go compiler via <code class="language-plaintext highlighter-rouge">-ldflags</code>. <code class="language-plaintext highlighter-rouge">-X main.version=abc</code> allows me to pass on the version information to the binary which is then used within the app in some fashion. <code class="language-plaintext highlighter-rouge">-s -w</code> disables the symbol table and the generation of debug data in form of DWARF in order to reduce the size of the binary which is useful for my production image.</p>

<p>This is just my take on this. If you have suggestions for improvements or any other remarks, please reach out. Thanks! <img class="emoji" title=":wave:" alt=":wave:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png" height="20" width="20"></p>


            </div>
            <label for="/blog/containerization-of-golang-applications" class="read-more-trigger"></label>
        
      </div>

      <p class="extra-info">
        
          Tags: docker, container, golang, go
        
      </p>
    </article>
  

  <!-- Pagination links -->
  <div class="pagination">
    
      <span class="previous">Newer</span>
    
    /
    
      <a href="/blog/page2/" class="next">Older</a>
    
  </div>

</div>

      </div>
    </main>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li>
            <a href="https://github.com/elsesiy" target="_blank"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
          <li>
            <a href="https://twitter.com/elsesiy" target="_blank"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
          <li>
            <a href="https://www.linkedin.com/in/elsesiy"><span class="icon icon--linked"><svg width="16px" height="16px" viewbox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
        </ul>
      </div>
      <div class="footer-col footer-col-2"></div>

      <div class="footer-col footer-col-3" style="text-align: right">
        <p>email: <a href="mailto:info@elsesiy.com">info@elsesiy.com</a><br>
          twitter: <a href="https://twitter.com/elsesiy" target="_blank">@elsesiy</a></p>
      </div>
    </div>

  </div>
</footer>

<script type="text/javascript">
  var links = document.links;
  for (var i = 0, linksLength = links.length; i < linksLength; i++) {
    if (links[i].hostname != window.location.hostname) {
      links[i].target = '_blank';
    } 
  }
</script>


  </body>

</html>
