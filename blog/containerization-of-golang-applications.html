<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/jpeg" href="/favicon.ico">
  <title>
    
      Containerization of Golang applications &middot; Jonas-Taha El Sesiy
    
  </title>
  
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="Jonas-Taha El Sesiy" href="/feed.xml">
  
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DCTKG65YG8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DCTKG65YG8', { 'anonymize_ip': true });
</script>

  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" href="/">Jonas-Taha El Sesiy</a>
  
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger">
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewbox="0 0 18 15" width="18px" height="15px">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a href="/" class="page-link active">Blog</a>
        <a href="/archive" class="page-link ">Archive</a>
        <a href="/about" class="page-link ">About</a>
      </div>
    </nav>
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="sidebar">
  <h1 style="font-size: 21px;">Jonas-Taha El Sesiy</h1>
  <p>Software Engineer</p>
  <p><a href="/about">Who am I?</a></p>
  <img src="/assets/Jonas-TahaElSesiy.jpg">

  <!-- Social links -->
  <ul class="social-media-list" style="margin-top: 20px; margin-bottom: 30px;">
    <li>
      <a href="https://github.com/elsesiy" target="_blank"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
    <li>
      <a href="https://twitter.com/elsesiy" target="_blank"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
    <li>
      <a href="https://www.linkedin.com/in/elsesiy"><span class="icon icon--linked"><svg width="16px" height="16px" viewbox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"></path></svg>
</span><span class="username">elsesiy</span></a>

    </li>
  </ul>

  <hr>

  <p style="line-height: 100%">
  <small>All views expressed are my own and not affiliated with current or former employers. Unless otherwise mentioned in the post, all projects are side projects which I work on on weekends and evenings.</small>
</p>
</div>


        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline"><a href="/blog/containerization-of-golang-applications">Containerization of Golang applications</a></h1>
    <p class="post-meta">
      <time datetime="2019-01-09T00:00:00+00:00" itemprop="datePublished">
        
        Jan 9, 2019
      </time>
  </p></header>

  <div class="post-content" itemprop="articleBody">
    <p>I’ve been a working a lot in <a href="https://golang.org/">Golang</a> recently and even though it easily allows for single static binary compilation I find myself using <a href="https://www.docker.com/">Docker</a> a lot. Why? Well, especially when it comes to container orchestration and scaling of workloads some sort of container technology is used as these build the foundation of a Pod in <a href="https://kubernetes.io/">Kubernetes</a> (our deployment infrastructure).</p>

<p>While coming up with an initial Dockerfile is easy, correctly compiling a Go application and adhere to all sorts of container best practices is still hard. Does the size of the binary matter? If so, you might want to provide some additional flags during compilation. 
Do you build the app outside of the container and just copy the final artifact into it or do you use multi-stage builds to have everything within an isolated environment? How do you deal with caching of layers? How do you make sure that the final container is secure and only contains whatever is needed to execute your application? 
<!--more-->
The first thing I was overwhelmed with is how much old information is still out there and that even well-known developers such as <a href="http://www.hockin.org/~thockin/">Tim Hockin</a> (co-creator of Kubernetes) are having <a href="https://twitter.com/thockin/status/758814480931229697?lang=en">questions</a> on how to actually compile a Golang application <em>correctly</em>. As it turns out, some flags are <a href="https://plus.google.com/117192131596509381660/posts/eNnNePihYnK">strictly unnecessary</a> as of Go 1.10 but are still widely used. Ultimately, it all depends on your needs and whether you need <a href="https://golang.org/cmd/cgo/">cgo</a> or not but even after studying a lot of blog posts I’m still not 100% sure about my approach. As it turns out, Tim created a nice <a href="https://github.com/thockin/go-build-template">skeleton project</a> which is a good starting point in my opinion.</p>

<p>Furthermore, I saw a lot of different approaches in terms of runtime base image and how the build process takes place. Some are using for <code class="language-plaintext highlighter-rouge">golang:alpine</code> with manually installing ca-certs, tzinfo, etc. during the build stage whereas others use plain <code class="language-plaintext highlighter-rouge">golang</code> instead. For the final stage common choices are either <code class="language-plaintext highlighter-rouge">scratch</code> or <code class="language-plaintext highlighter-rouge">alpine</code> which still provide a larger attack surface than i.e. <code class="language-plaintext highlighter-rouge">gcr.io/distroless/base</code>. As with many things, there’s not a single <em>correct</em> approach because one might want to keep the ability to <code class="language-plaintext highlighter-rouge">docker exec -it</code> into a container around whereas others have better ways to debug their services.</p>

<p>While coming up with my current solution I had the following considerations to take into account. Local development should still be fast, the build process must be CI-friendly with clean &amp; reproduceable builds and no additional tooling needed to secure the final image such as <a href="https://github.com/aquasecurity/microscanner">microscanner</a> or <a href="https://github.com/coreos/clair">clair</a>. Hence, I created a <code class="language-plaintext highlighter-rouge">Makefile</code> that helps me take care of the heavy lifting and allows for fast local development where no Docker is used at all. A shortened &amp; simplified version looks as follows:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">OUT</span> <span class="o">:=</span> binary-name
<span class="nv">PKG</span> <span class="o">:=</span> github.com/package
<span class="nv">VERSION</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> git describe <span class="nt">--always</span> <span class="nt">--dirty</span><span class="nf">)</span>
<span class="nv">PKG_LIST</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> go list <span class="nv">${PKG}</span>/...<span class="nf">)</span>
<span class="nv">GO_FILES</span> <span class="o">:=</span> <span class="nf">$(</span><span class="nb">shell</span> find <span class="nb">.</span> <span class="nt">-name</span> <span class="s1">'*.go'</span><span class="nf">)</span>

<span class="nl">build</span><span class="o">:</span>
	go build <span class="nt">-i</span> <span class="nt">-v</span> <span class="nt">-o</span> <span class="nv">${OUT}</span> <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-X main.version=</span><span class="nv">${VERSION}</span><span class="s2">"</span> <span class="nv">${PKG}</span>

<span class="nl">test</span><span class="o">:</span>
	<span class="p">@</span>go <span class="nb">test</span> <span class="nt">-short</span> <span class="nv">${PKG_LIST}</span>

<span class="nl">vet</span><span class="o">:</span>
	<span class="p">@</span>go vet <span class="nv">${PKG_LIST}</span>

<span class="nl">errorcheck</span><span class="o">:</span>
	<span class="p">@</span>errcheck <span class="nv">${PKG_LIST}</span>

<span class="nl">lint</span><span class="o">:</span>
	<span class="p">@</span><span class="k">for </span>file <span class="k">in</span> <span class="nv">${GO_FILES}</span> <span class="p">;</span>  <span class="k">do</span> <span class="se">\</span>
		golint <span class="nv">$$</span>file <span class="p">;</span> <span class="se">\</span>
	<span class="k">done</span>

<span class="nl">container</span><span class="o">:</span>
	<span class="p">@</span>docker build <span class="nt">--build-arg</span> <span class="nv">VERSION</span><span class="o">=</span><span class="nv">${VERSION}</span> <span class="nt">-t</span> registry/image:<span class="nv">${VERSION}</span> .

<span class="nl">container-push</span><span class="o">:</span>
	<span class="p">@</span>docker push registry/image:<span class="nv">${VERSION}</span>

<span class="nl">run</span><span class="o">:</span> <span class="nf">build</span>
	./<span class="nv">${OUT}</span>

<span class="nl">clean</span><span class="o">:</span>
	<span class="p">-</span>@rm <span class="nv">${OUT}</span> <span class="nv">${OUT}</span>-<span class="k">*</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">run build vet lint errorcheck</span>
</code></pre></div></div>

<p>I’ll talk about <code class="language-plaintext highlighter-rouge">-ldflags</code> in a bit, so don’t worry about it for now. Since the regular <code class="language-plaintext highlighter-rouge">go build</code> command doesn’t do static analysis on the project files, I created steps like <code class="language-plaintext highlighter-rouge">vet</code> (checks for correctness/suspicious constructs), <code class="language-plaintext highlighter-rouge">lint</code> (style mistakes) and <code class="language-plaintext highlighter-rouge">errorcheck</code> (missing error handling) I can run whenever I feel like it. This is not done implicitly through another step such as <code class="language-plaintext highlighter-rouge">build</code> because my CI system takes care of these things too. The rest of the file should be self-explanatory if you’re familiar with make.<br>
Now, the following <code class="language-plaintext highlighter-rouge">Dockerfile</code> is only used in my CI system for which I don’t mind it to fetch the dependencies during each build.</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Build stage</span>
<span class="k">FROM</span><span class="s"> golang:1.11.4 AS build-env</span>

<span class="k">LABEL</span><span class="s"> maintainer="Jonas-Taha El Sesiy &lt;github@elsesiy.com&gt;"</span>

<span class="k">WORKDIR</span><span class="s"> /project</span>
<span class="k">ARG</span><span class="s"> VERSION</span>
<span class="k">COPY</span><span class="s"> main.go go.mod go.sum ./</span>
<span class="k">RUN </span>bash <span class="nt">-c</span> <span class="s2">"go get -d &amp;&gt; /dev/null"</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-ldflags</span> <span class="s2">"-X main.version=</span><span class="k">${</span><span class="nv">VERSION</span><span class="k">}</span><span class="s2"> -s -w"</span> <span class="nt">-a</span> <span class="nt">-o</span> app .

<span class="c"># Final stage</span>
<span class="k">FROM</span><span class="s"> gcr.io/distroless/base</span>
<span class="k">COPY</span><span class="s"> --from=build-env /project/app .</span>
<span class="k">CMD</span><span class="s"> ["./app"]</span>
</code></pre></div></div>

<p>I’m using multi-stage builds with the latest Golang version as the base image. For the final stage, I opted for <a href="https://github.com/GoogleContainerTools/distroless#why-should-i-use-distroless-images">distroless</a> even though the final image is <strong>bigger</strong> than the other choices. Note that I’m using go modules for dependency management introduced in Go 1.11 for which I copy the <code class="language-plaintext highlighter-rouge">go.mod</code> and <code class="language-plaintext highlighter-rouge">go.sum</code> files into the container.<br>
As mentioned before, there are a couple of flags passed onto the go compiler via <code class="language-plaintext highlighter-rouge">-ldflags</code>. <code class="language-plaintext highlighter-rouge">-X main.version=abc</code> allows me to pass on the version information to the binary which is then used within the app in some fashion. <code class="language-plaintext highlighter-rouge">-s -w</code> disables the symbol table and the generation of debug data in form of DWARF in order to reduce the size of the binary which is useful for my production image.</p>

<p>This is just my take on this. If you have suggestions for improvements or any other remarks, please reach out. Thanks! <img class="emoji" title=":wave:" alt=":wave:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png" height="20" width="20"></p>


  </div>

  <p class="extra-info">
    
      Tags: docker, container, golang, go   |  
    
    <a href="https://github.com/elsesiy/elsesiy.com/edit/master/_posts/2019-01-09-containerization-of-golang-applications.md" target="_blank" class="forkButton">
  <svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
 
  Modify on GitHub
</a>
  </p>
</article>

      </div>
    </main>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li>
            <a href="https://github.com/elsesiy" target="_blank"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
          <li>
            <a href="https://twitter.com/elsesiy" target="_blank"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
          <li>
            <a href="https://www.linkedin.com/in/elsesiy"><span class="icon icon--linked"><svg width="16px" height="16px" viewbox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"></path></svg>
</span><span class="username">elsesiy</span></a>

          </li>
        </ul>
      </div>
      <div class="footer-col footer-col-2"></div>

      <div class="footer-col footer-col-3" style="text-align: right">
        <p>email: <a href="mailto:info@elsesiy.com">info@elsesiy.com</a><br>
          twitter: <a href="https://twitter.com/elsesiy" target="_blank">@elsesiy</a></p>
      </div>
    </div>

  </div>
</footer>

<script type="text/javascript">
  var links = document.links;
  for (var i = 0, linksLength = links.length; i < linksLength; i++) {
    if (links[i].hostname != window.location.hostname) {
      links[i].target = '_blank';
    } 
  }
</script>


  </body>

</html>
